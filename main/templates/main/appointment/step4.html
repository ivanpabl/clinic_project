{% extends 'main/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Шаг 4: Выбор времени</h3>
                    <div>
                        <span class="badge bg-light text-primary me-2">Врач: {{ doctor.full_name }}</span>
                        <span class="badge bg-light text-primary">Дата: {{ appointment_date|date:"d.m.Y" }}</span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="steps mb-4">
                    <div class="d-flex justify-content-between">
                        <div class="step">
                            <div class="step-circle">1</div>
                            <div class="step-label">Выбор услуги</div>
                        </div>
                        <div class="step">
                            <div class="step-circle">2</div>
                            <div class="step-label">Выбор врача</div>
                        </div>
                        <div class="step">
                            <div class="step-circle">3</div>
                            <div class="step-label">Выбор даты</div>
                        </div>
                        <div class="step active">
                            <div class="step-circle">4</div>
                            <div class="step-label">Выбор времени</div>
                        </div>
                        <div class="step">
                            <div class="step-circle">5</div>
                            <div class="step-label">Подтверждение</div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <div class="row">
                        <div class="col-md-6">
                            <i class="fas fa-user-md"></i> <strong>Врач:</strong> {{ doctor.full_name }}<br>
                            <i class="fas fa-calendar"></i> <strong>Дата:</strong> {{ appointment_date|date:"d.m.Y" }}
                        </div>
                        <div class="col-md-6">
                            <i class="fas fa-clock"></i> <strong>Рабочее время:</strong> {{ schedule.start_time|time:"H:i" }} - {{ schedule.end_time|time:"H:i" }}<br>
                            <i class="fas fa-door-open"></i> <strong>Кабинет:</strong> {{ schedule.room|default:"Уточнить в регистратуре" }}
                        </div>
                    </div>
                </div>

                {% if available_slots %}
                <form method="post" id="timeForm">
                    {% csrf_token %}
                    
                    <h5 class="mb-3">Выберите удобное время:</h5>
                    
                    <div class="time-slots">
                        {% for slot in available_slots %}
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" 
                                   name="appointment_time" 
                                   id="slot{{ forloop.counter }}" 
                                   value="{{ slot|date:'H:i:s' }}" 
                                   required>
                            <label class="form-check-label time-slot-label" 
                                   for="slot{{ forloop.counter }}">
                                <div class="time-slot-card">
                                    <div class="time-slot-time">{{ slot|time:"H:i" }}</div>
                                    <div class="time-slot-status available">
                                        <i class="fas fa-check-circle"></i> Свободно
                                    </div>
                                </div>
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="mt-4">
                        <h5>Информация о приеме:</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6><i class="fas fa-clock"></i> Длительность</h6>
                                        <p class="mb-0">{{ doctor.consultation_duration }} минут</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h6><i class="fas fa-money-bill-wave"></i> Стоимость</h6>
                                        <p class="mb-0">{{ doctor.consultation_price }} руб.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'appointment_step3' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Назад
                        </a>
                        <button type="submit" class="btn btn-primary" id="continueBtn">
                            Продолжить <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-clock fa-5x text-muted mb-3"></i>
                    <h4>Нет свободного времени</h4>
                    <p class="text-muted">
                        На выбранную дату все время занято. 
                        Пожалуйста, выберите другую дату.
                    </p>
                    <a href="{% url 'appointment_step3' %}" class="btn btn-primary">
                        <i class="fas fa-arrow-left"></i> Вернуться к выбору даты
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.step {
    text-align: center;
    flex: 1;
}
.step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-weight: bold;
}
.step.active .step-circle {
    background: #0d6efd;
    color: white;
}
.step-label {
    font-size: 0.9rem;
    color: #6c757d;
}
.step.active .step-label {
    color: #0d6efd;
    font-weight: bold;
}
.time-slot-label {
    width: 100%;
    cursor: pointer;
}
.time-slot-card {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
}
.time-slot-card:hover {
    background-color: #f8f9fa;
    border-color: #6c757d;
}
.time-slot-time {
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
}
.time-slot-status {
    font-size: 0.9rem;
}
.time-slot-status.available {
    color: #28a745;
}
.time-slot-status.unavailable {
    color: #dc3545;
}
.form-check-input:checked + .time-slot-label .time-slot-card {
    background-color: #e7f1ff;
    border-color: #0d6efd;
}
</style>

{% block extra_js %}
<script>
$(document).ready(function() {
    // Автоматическое выделение ближайшего доступного времени
    var currentTime = new Date();
    var currentHours = currentTime.getHours();
    var currentMinutes = currentTime.getMinutes();
    
    $('input[name="appointment_time"]').each(function() {
        var timeStr = $(this).val();
        var timeParts = timeStr.split(':');
        var slotHours = parseInt(timeParts[0]);
        var slotMinutes = parseInt(timeParts[1]);
        
        // Выделяем первый слот, который еще не прошел
        if (slotHours > currentHours || (slotHours === currentHours && slotMinutes > currentMinutes)) {
            $(this).prop('checked', true);
            return false; // Выходим из цикла
        }
    });
    
    // Проверка выбора времени перед отправкой
    $('#timeForm').on('submit', function(e) {
        if (!$('input[name="appointment_time"]:checked').length) {
            e.preventDefault();
            alert('Пожалуйста, выберите время');
        }
    });
});
</script>
{% endblock %}
{% endblock %}