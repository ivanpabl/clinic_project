{% extends 'main/base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0"><i class="fas fa-star"></i> Оставить отзыв о враче</h3>
            </div>
            <div class="card-body">
                
                <div class="doctor-info mb-4">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                {% if doctor.photo %}
                                <img src="{{ doctor.photo.url }}" 
                                     class="rounded-circle me-3" 
                                     width="80" height="80" 
                                     alt="{{ doctor.full_name }}">
                                {% endif %}
                                <div>
                                    <h4 class="mb-1">{{ doctor.full_name }}</h4>
                                    <p class="mb-1 text-muted">
                                        {{ doctor.specialization.name }} | 
                                        Стаж: {{ doctor.experience }} лет
                                    </p>
                                    <div class="rating mb-2">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= doctor.rating %}
                                                <i class="fas fa-star text-warning"></i>
                                            {% else %}
                                                <i class="far fa-star text-warning"></i>
                                            {% endif %}
                                        {% endfor %}
                                        <small>({{ doctor.reviews.count }} отзывов)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Правила оставления отзывов</h6>
                    <ul class="mb-0">
                        <li>Отзывы проходят модерацию перед публикацией</li>
                        <li>Оставляйте только конструктивные отзывы</li>
                        <li>Не указывайте личную информацию</li>
                        <li>Отзыв должен быть основан на личном опыте</li>
                    </ul>
                </div>
                
                <form method="post" id="reviewForm">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label class="form-label">
                            <strong>Оценка врача *</strong>
                        </label>
                        <div class="rating-input mb-3">
                            <div class="d-flex justify-content-center">
                                {% for i in "12345" %}
                                <input type="radio" name="rating" id="rating{{ i }}" 
                                       value="{{ i }}" 
                                       class="d-none" 
                                       {% if form.rating.value == forloop.counter %}checked{% endif %}>
                                <label for="rating{{ i }}" class="rating-star">
                                    <i class="far fa-star fa-2x"></i>
                                </label>
                                {% endfor %}
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">
                                    <span id="ratingText">Выберите оценку</span>
                                </small>
                            </div>
                        </div>
                        
                        {% if form.rating.errors %}
                        <div class="invalid-feedback d-block">
                            {{ form.rating.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-4">
                        <label for="id_comment" class="form-label">
                            <strong>Текст отзыва *</strong>
                        </label>
                        <textarea name="comment" class="form-control {% if form.comment.errors %}is-invalid{% endif %}" 
                                  id="id_comment" rows="6" 
                                  placeholder="Опишите ваш опыт посещения врача..." required>{{ form.comment.value|default:'' }}</textarea>
                        {% if form.comment.errors %}
                        <div class="invalid-feedback">
                            {{ form.comment.errors.0 }}
                        </div>
                        {% endif %}
                        
                        <div class="form-text">
                            <div class="d-flex justify-content-between">
                                <span>Минимум 20 символов</span>
                                <span id="charCount">0/1000 символов</span>
                            </div>
                            <div class="progress mt-1" style="height: 3px;">
                                <div id="charProgress" class="progress-bar" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check mb-4">
                        <input class="form-check-input" type="checkbox" id="confirm_review" required>
                        <label class="form-check-label" for="confirm_review">
                            Я подтверждаю, что был(а) на приеме у этого врача и отзыв основан 
                            на личном опыте. Я согласен(на) с публикацией отзыва на сайте.
                        </label>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'doctor_detail' doctor.id %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Вернуться
                        </a>
                        
                        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                            <i class="fas fa-paper-plane"></i> Отправить отзыв
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-comment-medical"></i> Пример хорошего отзыва</h5>
            </div>
            <div class="card-body">
                <div class="card border-success">
                    <div class="card-body">
                        <div class="rating mb-2">
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                            <i class="fas fa-star text-warning"></i>
                        </div>
                        <p class="mb-0">
                            "Доктор Иванова проявила высокий профессионализм, внимательно 
                            выслушала все жалобы, подробно объяснила диагноз и назначила 
                            эффективное лечение. Прием начался вовремя, доктор была вежлива 
                            и внимательна. Кабинет чистый и уютный. Рекомендую этого специалиста!"
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.rating-input {
    text-align: center;
}
.rating-star {
    cursor: pointer;
    color: #ddd;
    transition: color 0.2s;
    margin: 0 5px;
}
.rating-star:hover,
.rating-star:hover ~ .rating-star {
    color: #ffc107;
}
input[name="rating"]:checked ~ label {
    color: #ddd;
}
input[name="rating"]:checked + label,
input[name="rating"]:checked + label ~ label {
    color: #ffc107;
}
</style>

{% block extra_js %}
<script>
$(document).ready(function() {
    // Обновление текста оценки
    $('input[name="rating"]').on('change', function() {
        var rating = $(this).val();
        var texts = {
            '1': 'Ужасно - не рекомендую',
            '2': 'Плохо - есть серьезные проблемы',
            '3': 'Нормально - есть недочеты',
            '4': 'Хорошо - рекомендую',
            '5': 'Отлично - высший профессионализм'
        };
        $('#ratingText').text(texts[rating]);
    });
    
    // Счетчик символов
    $('#id_comment').on('input', function() {
        var length = $(this).val().length;
        $('#charCount').text(length + '/1000 символов');
        
        var percent = Math.min((length / 20) * 100, 100);
        $('#charProgress').css('width', percent + '%');
        
        if (length < 20) {
            $('#charProgress').removeClass('bg-success').addClass('bg-danger');
        } else if (length < 100) {
            $('#charProgress').removeClass('bg-danger').addClass('bg-warning');
        } else {
            $('#charProgress').removeClass('bg-warning').addClass('bg-success');
        }
    });
    
    // Блокировка кнопки отправки
    $('#confirm_review').on('change', function() {
        var rating = $('input[name="rating"]:checked').length;
        var comment = $('#id_comment').val().length >= 20;
        var confirmed = $(this).is(':checked');
        
        $('#submitBtn').prop('disabled', !(rating && comment && confirmed));
    });
    
    $('#id_comment, input[name="rating"]').on('input change', function() {
        $('#confirm_review').trigger('change');
    });
    
    // Инициализация
    if ($('input[name="rating"]:checked').length) {
        $('input[name="rating"]:checked').trigger('change');
    }
    $('#id_comment').trigger('input');
    $('#confirm_review').trigger('change');
});
</script>
{% endblock %}
{% endblock %}